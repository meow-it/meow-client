function showInstallPromotion(){let e=generateInstallationPromotionDiv();document.querySelector(".meowsContainer").insertAdjacentHTML("afterbegin",e)}async function beforeinstallpromptHandler(e){let t=await shouldWeShowInstallPrompt();deferredPrompt=e,t&&(wasPromptDeferred=!0,showInstallPromotion())}function toggleAccordion(){let e=this.getAttribute("aria-expanded");for(i=0;i<faqItems.length;i++)faqItems[i].setAttribute("aria-expanded","false");"false"==e&&this.setAttribute("aria-expanded","true")}function renderFirstVisit(){setDisplayNone(elements),elements.firstTimeVisit.style.display="flex"}async function main(){try{NProgress.start();let e=await getLocalForage("firstTimeVisit");if(null==e)return renderFirstVisit(),void NProgress.done();let t=await getLocalForage("user");if(null==t||0==t.status)return requestAnimationFrame(()=>{elements.newUser.style.display="flex"}),user=await register(),null!=user&&0!=user.status||(NProgress.done(),window.location.reload()),setTimeout(()=>(elements.newUser.style.display="none",elements.wrapper.style.display="flex",main()),3e3),user;user=t,NProgress.set(.5),userItem.username.textContent=user.name,userItem.profilePicture.src=user.profilePic;let o=await checkLocationPermission(),{isUpdated:n,locationPermission:s}=await getBooleanForLocation(o);if(!s)return setDisplayNone(elements),elements.location.style.display="flex",void NProgress.done();{setDisplayNone(elements);let e=getSavedTextData();document.querySelector(".meowInput").value=e;let t=await getPostsFromIndexedDB();meowCount=t.length;let o=0!=meowCount?generateMeows(t):generateNoMeows();document.querySelector(".meowsContainer").innerHTML=o,requestAnimationFrame(()=>{requestAnimationFrame(()=>{elements.wrapper.style.display="flex",NProgress.done()})});let s=n?await getUpdatedPosition():await getCurrentPosition();await setLocalForage("position",{latitude:s.coords.latitude,longitude:s.coords.longitude,accuracy:s.coords.accuracy,time:(new Date).getTime()});let a={latitude:s.coords.latitude,longitude:s.coords.longitude};updatePlaceInfo(a,s.coords.accuracy),NProgress.set(.7);let r=await getPosts(a);if(null==r)return void showStatus("You're Offline! 😢 Unable to refresh meows.");if(await setLocalForage("meows",r),NProgress.done(),0==meowCount||t[0]._id==r[0]._id){let e=0!=r.length?generateMeows(r):generateNoMeows();document.querySelector(".meowsContainer").innerHTML=e}else{if(0==r.length)return void showStatus("No meows found here! 😶 Reload to update!");showStatus("New meows found! 🎉 Reload to update!")}}return requestAnimationFrame(()=>{requestAnimationFrame(()=>{"twa"!=launchDisplayType&&"standalone"!=launchDisplayType||(installPWAButtonOnUserInfo.style.display="none"),1==wasPromptDeferred&&(doesElementWithClassNameExists("installationPromotionCard")||showInstallPromotion());let e=document.querySelector(".commentingUserProfilePicture");e.src=user.profilePic,e.alt=user.name,n&&(showStatus("Using your last known location for refreshing the feed 🎉 <br> Turn on GPS to get the meows for your current location 📍"),setTimeout(()=>{hideStatus()},5e3))})}),NProgress.done(),user}catch(e){console.trace("Something went wrong 😟"+e),showStatus("Something went wrong 😟")}}function doesElementWithClassNameExists(e){let t=document.querySelector(`.${e}`);return null!=t}async function updatePlaceInfo(e,t,o=!1){let n=await getPlaceInfo(e);if(null==n)return;let s=getLocationString(n),a=o?".meowLocationText":".locationText",r=document.querySelector(a);r.textContent=s,!o&&(r.dataset.accuracy=t),!o&&await setLocalForage("placeInfo",s)}function hideStatus(){statusElements.currentFeedStatus.style.top="-3.125rem",statusElements.locationHolder.style.marginTop="0px"}function showStatus(e){statusElements.currentFeedStatus.innerHTML=e,statusElements.currentFeedStatus.style.top="4.1875rem";let t=getComputedStyle(statusElements.currentFeedStatus).height;statusElements.locationHolder.style.marginTop=t}async function showMeow(){document.querySelector(".meowFromId").style.display="flex";let e=params.get("meow"),t=await getSingleMeow(e);null==t&&(window.location.href=window.location.origin);let o={longitude:t.location.coordinates[0],latitude:t.location.coordinates[1]};updatePlaceInfo(o,.1,!0);let n=generateMeow(t);document.querySelector(".meowContainer").innerHTML=n}async function handleCommentsButtonClick(e){selectedMeowForShowingComments=e.target.dataset.id,setDisplayNone(elements),document.querySelector(".commentsModalContainer").style.display="flex";let t=await getLocalForage("meows"),o=t.find(e=>e._id==selectedMeowForShowingComments),n=generateMeows([o]);document.querySelector(".commentMeowContainer").innerHTML=n;let s=document.querySelector(".commentsContainer");requestAnimationFrame(()=>{requestAnimationFrame(()=>{s.innerHTML=commentsPlaceholderDiv()})});let a=await getComments(selectedMeowForShowingComments);if(null==a)return;let r=0==a.length?commentsPlaceholderDiv(!0):generateComments(a);requestAnimationFrame(()=>{requestAnimationFrame(()=>{s.innerHTML=r})})}function handleCloseCommentsButtonClick(){document.querySelector(".commentsModalContainer").style.display="none",elements.wrapper.style.display="flex",document.querySelector(".commentMeowContainer").innerHTML="",document.querySelector(".commentsContainer").innerHTML=""}function handleCreateButtonClick(){setDisplayNone(elements);let e=document.querySelector(".newMeowModalContainer");e.style.display="block"}function handleCloseNewMeowModal(){doesElementWithClassNameExists("newMeowStatusMessage")&&(document.querySelector(".newMeowStatusMessage").style.display="none");let e=document.querySelector(".newMeowModalContainer");e.style.display="none",elements.wrapper.style.display="flex"}function handlePromotionClick(){window.location.href=window.location.origin}function closeLocationFAQ(e=!1){setDisplayNone(elements),e?elements.userInfo.style.display="flex":elements.location.style.display="flex"}function showUserInfo(){setDisplayNone(elements),document.querySelector(".infoUsername").textContent=user.name,document.querySelector(".infoUserProfilePicture").src=user.profilePic,document.querySelector(".infoUserProfilePicture").alt=user.name,elements.userInfo.style.display="flex"}function showFAQ(){setDisplayNone(elements),elements.whyLocationInfo.style.display="flex"}function closeUserInfo(){setDisplayNone(elements),elements.wrapper.style.display="flex"}async function logoutUser(){await localforage.clear(),window.location.href="./"}function hideInstallationPromotion(){try{let e=document.querySelector(".installationPromotionCard");e.style.display="none"}catch(e){console.log(`Couldn't find any div with class .installationPromotionCard 😢: ${e}`)}}async function userSaidNOToInstall(){await setLocalForage("disUserSayNOForInstallation",!0),hideInstallationPromotion()}async function installApp(){hideInstallationPromotion(),deferredPrompt.prompt();let{outcome:e}=await deferredPrompt.userChoice;console.log(`User response to the install prompt: ${e}`)}async function createMeow(){NProgress.start();let e=document.querySelector(".meowsContainer"),t=document.querySelector(".meowInput"),o=t.value;if(0==o.trim().length)return void NProgress.done();let n=await getLocalForage("backgroundSync"),s={};try{let e=await getCurrentPosition();s=e.coords}catch(e){let t=await getUpdatedPosition();s=t.coords}if(navigator.onLine){let a=!1;if(n){let n={text:o,userid:user._id,coords:{latitude:s.latitude,longitude:s.longitude}};await addToBGSyncMeowRegistry(n);let r={...n,likes:0,toxic:!1,_id:"temporaryMeow",comments:[],createdAt:new Date,updatedAt:new Date,name:user.name,profilePic:user.profilePic,likedBy:[],isReviewed:!1},i=generateMeows([r]);e.innerHTML=i+e.innerHTML,a=!0,t.value="",clearTextData(),NProgress.done(),handleCloseNewMeowModal()}let r=await newMeow(o,s,user._id);if(null==r._id)return void NProgress.done();if(n&&a){let t=await getLocalForage("meowQueue");t.pop(),await setLocalForage("meowQueue",t),e.removeChild(e.firstChild)}NProgress.set(.7),await refreshDBWithCreatedMeow(r),t.value="",clearTextData();let i=generateMeows([r]),l=e.innerHTML;e.innerHTML=0==meowCount?i:i+l,NProgress.done(),meowCount++,handleCloseNewMeowModal()}else{let e=document.querySelector(".newMeowStatusMessage"),a=e.querySelectorAll("span")[0],r=e.querySelector(".goBackToHomeButton");if(null==window.chrome)requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.style.display="flex",a.innerHTML="You're Offline! Try sending the meow when you're online. 😞 Bruh, Try using Chromium Browsers for a rich offline experience!",r.style.color="#f3624c"})});else if(n){let n={text:o,userid:user._id,coords:{latitude:s.latitude,longitude:s.longitude}};await addToBGSyncMeowRegistry(n),requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.style.display="flex",e.style.backgroundColor="#0070f3",a.innerHTML="You're Offline! But don't worry 🤠 Your meow is scheduled to be sent automatically 🤖 when your device gets connected to the internet 🌐",r.style.color="#0070f3"})}),t.value="",clearTextData(),meowCount++}else requestAnimationFrame(()=>{requestAnimationFrame(()=>{e.style.display="flex",e.style.backgroundColor="#f3624c",a.style.fontSize="1.2rem",a.innerHTML="You're Offline! Background Sync is not allowed in your browser. Try allowing it in site settings to schedule this meow to be posted automatically in the background when your device gets connected to the internet or try sending this meow when you're online. 😞",r.style.color="#f3624c"})});NProgress.done()}await setLocalForage("disUserSayNOForInstallation",!1)}async function postingComments(e){NProgress.start();let t=document.querySelector(".commentsContainer"),o="serviceWorker"in navigator&&"SyncManager"in window,n=document.querySelector(".commentInput"),s=n.value;if(0==s.trim().length)return void NProgress.done();s=s.substring(0,e);let a=user._id,r=selectedMeowForShowingComments,i=!1,l=document.querySelector(".postingCommentSpinner");if(l.style.display="block",o){let e={text:s,userId:a,meowId:r};await addToBGSyncCommentsRegistry(e);let o={...e,_id:"",isReviewed:!1,toxic:!1,createdAt:new Date,name:user.name,profilePic:user.profilePic},c=generateComments([o]);t.innerHTML=c+t.innerHTML,i=!0,n.value="",l.style.display="none"}let c=await createNewComment({text:s,userId:a,meowId:r});if(NProgress.set(.7),null!=c){let e=generateComments([c]);if(i&&t.removeChild(t.firstChild),t.innerHTML=e+t.innerHTML,n.value="",o){let e=await getLocalForage("commentQueue");null!=e&&(e.pop(),await setLocalForage("commentQueue",e))}}NProgress.done(),l.style.display="none"}function closeMeowWhileOffline(){let e=document.querySelector(".newMeowModalContainer"),t=document.querySelector(".newMeowStatusMessage");e.style.display="none",t.style.display="none",elements.wrapper.style.display="flex"}async function refreshDBWithCreatedMeow(e){let t=await getLocalForage("meows");t.unshift(e),await setLocalForage("meows",t)}let deferredPrompt,user,wasPromptDeferred=!1,faqButtonWasPressed=!1,selectedMeowForShowingComments=null,max=140;window.addEventListener("beforeinstallprompt",async e=>{await beforeinstallpromptHandler(e)}),window.addEventListener("appinstalled",()=>{console.log("App installed! 🎉"),hideInstallationPromotion()});let meowCount=0,launchDisplayType=getPWADisplayMode(),installPWAButtonOnUserInfo=document.querySelector(".installPWAFromUser"),elements={newUser:document.querySelector(".newUserLoading"),postsLoading:document.querySelector(".postsLoading"),location:document.querySelector(".noLocationAccess"),wrapper:document.querySelector(".wrapper"),firstTimeVisit:document.querySelector(".firstTimeVisit"),whyLocationInfo:document.querySelector(".whyLocationInfo"),userInfo:document.querySelector(".userInfo")},statusElements={currentFeedStatus:document.querySelector(".currentFeedStatus"),locationHolder:document.querySelector(".locationHolder")},geoPermissionCount=0,faqItems=document.querySelectorAll(".accordion button");faqItems.forEach(e=>e.addEventListener("click",toggleAccordion)),document.querySelector(".whatIsThis button").addEventListener("click",async()=>{await setLocalForage("firstTimeVisit",!0),window.location.reload()}),document.querySelector(".learnMore").addEventListener("click",()=>{showFAQ()}),document.querySelector(".commentInput").addEventListener("keydown",async e=>{"ENTER"!=e.key&&13!=e.keyCode||postingComments(max);let t=e.target.value.length,o=max-t;o<0&&(e.target.value=e.target.value.slice(0,max))}),document.querySelector(".givePermissionButton").addEventListener("click",e=>{navigator.geolocation.getCurrentPosition(()=>{window.location.reload()},()=>{if(geoPermissionCount>0){let t=e.target.parentElement.querySelector(".learnMore");t.textContent="You have denied access to your location. You can change this in your browser settings. Click here to learn more ↗",t.classList.add("newAlert")}geoPermissionCount++})});let params=new URLSearchParams(window.location.search);params.has("meow")?showMeow():main();let userItem={};userItem.username=document.querySelector(".username"),userItem.profilePicture=document.querySelector(".profilePicture"),document.addEventListener("click",e=>{e.target.classList.contains("likeButton")?handleLike(e):e.target.classList.contains("hideMessage")?handleEye(e):e.target.classList.contains("createNewMeowButton")?handleCreateButtonClick():e.target.classList.contains("commentButton")?handleCommentsButtonClick(e):e.target.classList.contains("closeComments")?handleCloseCommentsButtonClick():e.target.classList.contains("cancelMeow")?handleCloseNewMeowModal():e.target.classList.contains("reportButton")?handleReview(e):e.target.classList.contains("createMeow")?createMeow(e):e.target.classList.contains("shareMeowButton")?handleShareButton(e):e.target.classList.contains("currentLocation")?handleLocationIconClick(e):e.target.classList.contains("promotion")||e.target.classList.contains("promotionHolder")?handlePromotionClick():e.target.classList.contains("cancelGoBack")?faqButtonWasPressed?closeLocationFAQ(!0):closeLocationFAQ():e.target.classList.contains("closeUserInfo")?closeUserInfo():e.target.classList.contains("profilePicture")?showUserInfo():e.target.classList.contains("deleteCache")?deleteCache():e.target.classList.contains("logoutButton")?logoutUser():e.target.classList.contains("goBackToHomeButton")?closeMeowWhileOffline():e.target.classList.contains("installButton")?installApp():e.target.classList.contains("notNowButton")?userSaidNOToInstall():e.target.classList.contains("installPWAButtonFromUserInfo")?installApp():e.target.classList.contains("showFaqSpan")?(showFAQ(),faqButtonWasPressed=!0):e.target.classList.contains("postCommentButton")&&postingComments(max)}),document.querySelector(".meowInput").addEventListener("input",countCharactersInTextField);